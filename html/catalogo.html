<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Maching – Catálogo</title>

  <script type="importmap">
    { "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }}
  </script>

  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.12.58/build/spline-viewer.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;}
    body{background:#000;color:#fff;overflow-x:hidden;}

    nav{
      position:fixed;top:25px;left:50%;transform:translateX(-50%);
      width:85%;padding:18px 50px;
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);
      border-radius:50px;z-index:1000;transition:.4s;
    }
    .logo{font-weight:500;letter-spacing:3px;font-size:14px;
          text-decoration:none;color:#fff;}
    nav ul{display:flex;gap:35px;list-style:none;}
    nav ul li{cursor:pointer;transition:.3s;}
    nav ul li a{text-decoration:none;color:#fff;display:block;}
    nav ul li a:hover,nav ul li:hover{opacity:.6;}

    .hero-catalog{
      height:100vh;width:100%;
      display:flex;align-items:center;
      padding-left:8%;
      background:#000;
      position:relative;overflow:hidden;
    }
    .hero-catalog::after{
      content:'';position:absolute;inset:0;
      background:radial-gradient(circle at 25% 50%,
        rgba(0,0,0,.9) 0%,rgba(0,0,0,.7) 30%,
        rgba(0,0,0,.4) 50%,rgba(0,0,0,.15) 65%,transparent 80%);
      z-index:1;pointer-events:none;
    }
    .hero-catalog-text{
      position:relative;z-index:2;max-width:550px;
      animation:entrada 1.5s ease;
    }
    .hero-small{
      font-size:13px;letter-spacing:4px;opacity:.4;
      text-transform:uppercase;margin-bottom:16px;
    }
    .hero-catalog-text h1{
      font-size:75px;font-weight:300;letter-spacing:6px;line-height:1;
      text-shadow:0 0 5px rgba(0,200,255,.3),0 0 20px rgba(0,200,255,.1);
    }
    .hero-catalog-text h2{
      font-size:75px;font-weight:700;letter-spacing:6px;line-height:1;
      text-shadow:0 0 5px rgba(0,200,255,.3),0 0 20px rgba(0,200,255,.1);
    }
    .hero-catalog-text .sub{
      margin-top:22px;font-size:18px;opacity:.6;max-width:460px;line-height:1.6;
    }
    .hero-buttons{margin-top:32px;}
    .btn-hero{
      display:inline-block;padding:14px 36px;border-radius:50px;
      border:1px solid rgba(255,255,255,.2);color:#fff;text-decoration:none;
      font-size:13px;letter-spacing:3px;
      background:rgba(255,255,255,.05);backdrop-filter:blur(10px);transition:.3s;
    }
    .btn-hero:hover{background:rgba(0,200,255,.15);border-color:rgba(0,200,255,.5);}

    .spline-wrapper{
      position:absolute;right:0;top:0;width:60%;height:100%;z-index:0;
    }
    spline-viewer.robot-3d{
    position: absolute;
    top:0;
    right: -20%;
} 
    .spline-cover{
      position:absolute;bottom:0;left:0;width:100%;height:120px;
      background:linear-gradient(to top,#000 0%,transparent 100%);
      pointer-events:none;z-index:2;
    }

    .section-catalog{padding:80px 8%;background:#0e0e0e;}
    .catalog-header{text-align:center;margin-bottom:60px;}
    .catalog-header p{font-size:13px;letter-spacing:4px;opacity:.4;text-transform:uppercase;margin-bottom:16px;}
    .catalog-header h2{font-size:52px;font-weight:300;letter-spacing:4px;}
    .catalog-header h2 span{font-weight:700;}

    .search-wrap{display:flex;flex-direction:column;align-items:center;gap:20px;margin-bottom:50px;max-width:1400px;margin-left:auto;margin-right:auto;}
    .search-wrap input{
      width:100%;max-width:480px;text-align:center;padding:14px 24px;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      border-radius:50px;color:#fff;font-size:15px;outline:none;transition:.3s;
    }
    .search-wrap input::placeholder{opacity:.35;}
    .search-wrap input:focus{
      border-color:rgba(0,200,255,.4);background:rgba(0,200,255,.04);
      box-shadow:0 0 20px rgba(0,200,255,.08);
    }
    .filters{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
    .filters button{
      padding:9px 22px;border-radius:50px;
      border:1px solid rgba(255,255,255,.1);
      background:transparent;color:rgba(255,255,255,.5);
      font-size:13px;letter-spacing:1px;cursor:pointer;transition:.3s;
    }
    .filters button:hover{border-color:rgba(0,200,255,.5);color:#fff;}
    .filters button.active{
      background:rgba(0,200,255,.12);border-color:rgba(0,200,255,.5);color:#fff;
    }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      gap:28px;
      max-width:1400px;
      margin:0 auto;
    }

    .product-card{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.07);
      border-radius:20px;overflow:hidden;cursor:pointer;
      opacity:0;transform:translateY(50px);
      transition:transform .4s ease,box-shadow .4s ease,border-color .4s ease,opacity .6s ease;
      display:flex;flex-direction:column;
    }
    .product-card.show{opacity:1;transform:translateY(0);}
    .product-card:hover{
      transform:translateY(-8px);
      box-shadow:0 20px 50px rgba(0,200,255,.1),0 5px 20px rgba(0,0,0,.6);
      border-color:rgba(0,200,255,.25);
    }

    .card-3d-viewer{
      width:100%;height:240px;min-height:240px;
      background:radial-gradient(circle at 50% 60%,#0d1a2a 0%,#080808 70%);
      position:relative;overflow:hidden;flex-shrink:0;
    }
    .card-3d-viewer canvas{
      position:absolute!important;top:0;left:0;
      width:100%!important;height:100%!important;display:block;z-index:2;
    }
    .card-3d-viewer.loaded .card-3d-loading{display:none;}
    .card-3d-badge{
      position:absolute;top:12px;right:12px;z-index:10;
      font-size:9px;letter-spacing:2px;
      background:rgba(0,200,255,.15);border:1px solid rgba(0,200,255,.3);
      padding:3px 10px;border-radius:20px;color:rgba(0,200,255,.9);
    }
    .card-3d-loading{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      z-index:5;pointer-events:none;
    }
    .card-3d-loading::after{
      content:'';width:24px;height:24px;border-radius:50%;
      border:2px solid rgba(0,200,255,.2);border-top-color:rgba(0,200,255,.8);
      animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    .card-info{padding:20px 24px 24px;display:flex;flex-direction:column;flex:1;}
    .card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
    .card-categoria{
      font-size:10px;letter-spacing:3px;text-transform:uppercase;
      color:rgba(0,200,255,.7);display:block;
    }
    .card-stock{
      font-size:10px;letter-spacing:1px;
      color:rgba(100,255,150,.7);
      background:rgba(100,255,150,.08);border:1px solid rgba(100,255,150,.2);
      padding:2px 8px;border-radius:20px;white-space:nowrap;
    }
    .card-info h3{font-size:18px;font-weight:600;letter-spacing:.5px;margin-bottom:8px;line-height:1.3;}
    .card-desc{font-size:13px;opacity:.5;line-height:1.7;margin-bottom:14px;flex:1;}

    .card-specs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;}
    .spec-tag{
      font-size:11px;letter-spacing:.5px;
      background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
      padding:4px 10px;border-radius:8px;color:rgba(255,255,255,.5);
    }

    .card-footer{
      display:flex;justify-content:space-between;align-items:center;
      padding-top:14px;border-top:1px solid rgba(255,255,255,.06);
    }
    .card-price{font-size:13px;font-weight:600;color:rgba(0,200,255,.9);letter-spacing:1px;}
    .card-btn{
      font-size:11px;letter-spacing:1.5px;
      color:#fff;text-decoration:none;
      background:rgba(0,200,255,.1);border:1px solid rgba(0,200,255,.25);
      padding:6px 14px;border-radius:20px;transition:.3s;
    }
    .card-btn:hover{background:rgba(0,200,255,.2);border-color:rgba(0,200,255,.5);}

    .empty-state{
      grid-column:1/-1;text-align:center;
      opacity:.3;font-size:16px;padding:80px 0;letter-spacing:2px;
    }

    .modal{
      display:none;position:fixed;inset:0;z-index:2000;
      background:rgba(0,0,0,.85);backdrop-filter:blur(20px);
      align-items:center;justify-content:center;padding:20px;
    }
    .modal.open{display:flex;}
    .modal-content{
      width:100%;max-width:900px;max-height:90vh;overflow-y:auto;
      background:#0e0e0e;border:1px solid rgba(255,255,255,.08);
      border-radius:24px;padding:40px;position:relative;
      animation:entrada .4s ease;
    }
    .modal-close{
      position:absolute;top:20px;right:24px;
      background:none;border:none;color:#fff;font-size:28px;
      cursor:pointer;opacity:.4;transition:.3s;line-height:1;
    }
    .modal-close:hover{opacity:1;}
    .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:40px;}
    .modal-3d{
      width:100%;height:320px;background:#050505;
      border-radius:16px;overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
    }
    .modal-3d canvas{width:100%!important;height:100%!important;display:block;}
    .modal-info{display:flex;flex-direction:column;gap:16px;}
    .modal-info .categoria-badge{
      font-size:11px;letter-spacing:3px;text-transform:uppercase;
      color:rgba(0,200,255,.7);
    }
    .modal-info h2{font-size:32px;font-weight:300;letter-spacing:3px;}
    .modal-info p{font-size:15px;opacity:.6;line-height:1.8;}
    .modal-actions{display:flex;gap:14px;margin-top:10px;}
    .btn-primary{
      padding:12px 28px;border-radius:50px;
      background:rgba(0,200,255,.15);border:1px solid rgba(0,200,255,.4);
      color:#fff;font-size:13px;letter-spacing:2px;
      text-decoration:none;cursor:pointer;transition:.3s;
    }
    .btn-primary:hover{background:rgba(0,200,255,.25);}
    .btn-secondary{
      padding:12px 28px;border-radius:50px;
      background:transparent;border:1px solid rgba(255,255,255,.1);
      color:#fff;font-size:13px;letter-spacing:2px;cursor:pointer;transition:.3s;
    }
    .btn-secondary:hover{border-color:rgba(255,255,255,.3);}

    .main-footer{
      border-top:1px solid #1e1e1e;padding:60px 10% 0;
      color:#e7e7e7;margin-top:100px;
    }
    .footer-container{
      display:grid;grid-template-columns:2fr 1fr 1fr 1fr;
      gap:40px;padding-bottom:50px;
    }
    .footer-col h2{font-size:1.2rem;font-weight:300;letter-spacing:.15rem;
      margin-bottom:16px;color:#fff;}
    .footer-col h3{font-size:.85rem;font-weight:600;letter-spacing:.12rem;
      text-transform:uppercase;color:#474747;margin-bottom:18px;}
    .footer-col p{font-size:.85rem;color:gray;line-height:1.7;
      max-width:280px;margin-bottom:20px;}
    .footer-col ul{list-style:none;display:flex;flex-direction:column;gap:12px;}
    .footer-col ul li a{font-size:.9rem;color:gray;text-decoration:none;
      letter-spacing:.05rem;transition:color .2s ease;position:relative;}
    .footer-col ul li a::before{content:'→';position:absolute;left:-20px;
      opacity:0;transition:all .3s ease;}
    .footer-col ul li a:hover{color:#e7e7e7;padding-left:20px;}
    .footer-col ul li a:hover::before{opacity:1;left:0;}
    .socials{display:flex;gap:16px;}
    .socials a{font-size:.8rem;color:#474747;text-decoration:none;
      border:1px solid #2a2a2a;padding:5px 14px;border-radius:50px;
      letter-spacing:.08rem;transition:color .2s,border-color .2s;}
    .socials a:hover{color:#e7e7e7;border-color:#555;}
    .footer-bottom{border-top:1px solid #1e1e1e;padding:20px 0;
      text-align:center;font-size:.8rem;color:#333;letter-spacing:.05rem;}

    @keyframes entrada{
      from{opacity:0;transform:translateY(40px);}
      to{opacity:1;transform:translateY(0);}
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <a class="logo" href="../index.html">SMART MACHING</a>
  <ul>
    <li><a href="../index.html">Inicio</a></li>
    <li><a href="catalogo.html">Herramientas</a></li>
    <li><a href="chatbot.html">Chatbot IA</a></li>
    <li><a href="ra.html">Realidad Aumentada</a></li>
  </ul>
</nav>

<!-- HERO -->
<div class="hero-catalog">
  <div class="hero-catalog-text">
    <p class="hero-small">Smart Maching</p>
    <h1>CATÁLOGO DE</h1>
    <h2>HERRAMIENTAS</h2>
    <p class="sub">Explora nuestra línea completa de herramientas de precisión con visualización 3D en tiempo real.</p>
    <div class="hero-buttons">
      <a href="#catalogo" class="btn-hero">EXPLORAR</a>
    </div>
  </div>
  <div class="spline-wrapper">
    <spline-viewer class="robot-3d" url="https://prod.spline.design/GNu0n115D2Pr-I8O/scene.splinecode"></spline-viewer>
    <div class="spline-cover"></div>
  </div>
</div>

<!-- CATÁLOGO -->
<section class="section-catalog" id="catalogo">
  <div class="catalog-header">
    <p>Smart Maching</p>
    <h2>Encuentra la herramienta <span>perfecta</span></h2>
  </div>
  <div class="search-wrap">
    <input type="text" id="searchInput" placeholder="Buscar herramienta..." oninput="filterProducts()">
    <div class="filters">
      <button class="active" onclick="filterByCategory('all',this)">Todas</button>
      <button onclick="filterByCategory('Fresas',this)">Fresas</button>
      <button onclick="filterByCategory('Brocas',this)">Brocas</button>
      <button onclick="filterByCategory('Insertos',this)">Insertos</button>
      <button onclick="filterByCategory('Tornos',this)">Tornos</button>
      <button onclick="filterByCategory('Centros de mecanizado',this)">Centros de mecanizado</button>
    </div>
  </div>

  <div class="products-grid" id="productsGrid">

    <article class="product-card" data-categoria="Fresas" onclick="openToolModal(0)">
      <div class="card-3d-viewer" id="viewer-card-0">
        <span class="card-3d-badge">3D</span>
        <div class="card-3d-loading"></div>
      </div>
      <div class="card-info">
        <div class="card-top">
          <span class="card-categoria">Fresas</span>
          <span class="card-stock">● En stock</span>
        </div>
        <h3>Fresa de Carburo 4 Flautas</h3>
        <p class="card-desc">Fresa de carburo sólido de 4 flautas para mecanizado de alta velocidad en aceros, aceros inoxidables y aleaciones de aluminio. Recubrimiento AlTiN.</p>
        <div class="card-specs">
          <span class="spec-tag">Ø 10mm</span>
          <span class="spec-tag">4 Flautas</span>
          <span class="spec-tag">HRC 65</span>
          <span class="spec-tag">AlTiN</span>
        </div>
        <div class="card-footer">
          <span class="card-price">REF: SM-FR-001</span>
          <a class="card-btn" href="#">Ver detalle →</a>
        </div>
      </div>
    </article>

    <article class="product-card" data-categoria="Brocas" onclick="openToolModal(1)">
      <div class="card-3d-viewer" id="viewer-card-1">
        <span class="card-3d-badge">3D</span>
        <div class="card-3d-loading"></div>
      </div>
      <div class="card-info">
        <div class="card-top">
          <span class="card-categoria">Brocas</span>
          <span class="card-stock">● En stock</span>
        </div>
        <h3>Broca HSS Ø10mm</h3>
        <p class="card-desc">Broca de acero rápido con recubrimiento TiN para perforación precisa en acero, fundición gris y materiales ferrosos. Alta durabilidad.</p>
        <div class="card-specs">
          <span class="spec-tag">Ø 10mm</span>
          <span class="spec-tag">HSS-TiN</span>
          <span class="spec-tag">L: 133mm</span>
          <span class="spec-tag">DIN 338</span>
        </div>
        <div class="card-footer">
          <span class="card-price">REF: SM-BR-010</span>
          <a class="card-btn" href="#">Ver detalle →</a>
        </div>
      </div>
    </article>

    <article class="product-card" data-categoria="Insertos" onclick="openToolModal(2)">
      <div class="card-3d-viewer" id="viewer-card-2">
        <span class="card-3d-badge">3D</span>
        <div class="card-3d-loading"></div>
      </div>
      <div class="card-info">
        <div class="card-top">
          <span class="card-categoria">Insertos</span>
          <span class="card-stock">● En stock</span>
        </div>
        <h3>Inserto CCMT 09T304</h3>
        <p class="card-desc">Inserto de carburo cementado para torneado de acabado. Excelente rendimiento en acero inoxidable, materiales difíciles y aleaciones especiales.</p>
        <div class="card-specs">
          <span class="spec-tag">ISO P/M/K</span>
          <span class="spec-tag">Radio 0.4mm</span>
          <span class="spec-tag">CVD</span>
          <span class="spec-tag">Rompevirutas</span>
        </div>
        <div class="card-footer">
          <span class="card-price">REF: SM-IN-304</span>
          <a class="card-btn" href="#">Ver detalle →</a>
        </div>
      </div>
    </article>

    <article class="product-card" data-categoria="Tornos" onclick="openToolModal(3)">
      <div class="card-3d-viewer" id="viewer-card-3">
        <span class="card-3d-badge">3D</span>
        <div class="card-3d-loading"></div>
      </div>
      <div class="card-info">
        <div class="card-top">
          <span class="card-categoria">Tornos</span>
          <span class="card-stock">● En stock</span>
        </div>
        <h3>Portaherramientas VDI 40</h3>
        <p class="card-desc">Portaherramientas estático VDI 40 para torno CNC. Alta rigidez estructural, excelente repetibilidad de posicionamiento y fácil cambio.</p>
        <div class="card-specs">
          <span class="spec-tag">VDI 40</span>
          <span class="spec-tag">20mm bore</span>
          <span class="spec-tag">Acero bonif.</span>
          <span class="spec-tag">DIN 69880</span>
        </div>
        <div class="card-footer">
          <span class="card-price">REF: SM-TO-040</span>
          <a class="card-btn" href="#">Ver detalle →</a>
        </div>
      </div>
    </article>

    <article class="product-card" data-categoria="Centros de mecanizado" onclick="openToolModal(4)">
      <div class="card-3d-viewer" id="viewer-card-4">
        <span class="card-3d-badge">3D</span>
        <div class="card-3d-loading"></div>
      </div>
      <div class="card-info">
        <div class="card-top">
          <span class="card-categoria">Centros de mecanizado</span>
          <span class="card-stock">● En stock</span>
        </div>
        <h3>Mandril BT40 ER32</h3>
        <p class="card-desc">Mandril de pinzas ER32 con adaptador BT40 para centros de mecanizado vertical y horizontal. Runout &lt; 0.003mm garantizado.</p>
        <div class="card-specs">
          <span class="spec-tag">BT40</span>
          <span class="spec-tag">ER32</span>
          <span class="spec-tag">L: 100mm</span>
          <span class="spec-tag">Balanceado G2.5</span>
        </div>
        <div class="card-footer">
          <span class="card-price">REF: SM-CM-BT40</span>
          <a class="card-btn" href="#">Ver detalle →</a>
        </div>
      </div>
    </article>

    <article class="product-card" data-categoria="Fresas" onclick="openToolModal(5)">
      <div class="card-3d-viewer" id="viewer-card-5">
        <span class="card-3d-badge">3D</span>
        <div class="card-3d-loading"></div>
      </div>
      <div class="card-info">
        <div class="card-top">
          <span class="card-categoria">Fresas</span>
          <span class="card-stock">● En stock</span>
        </div>
        <h3>Fresa de Bola Ø6mm</h3>
        <p class="card-desc">Fresa de punta esférica para acabado de superficies complejas, moldes y matrices 3D. Carburo micrograno con recubrimiento TiAlN.</p>
        <div class="card-specs">
          <span class="spec-tag">Ø 6mm</span>
          <span class="spec-tag">2 Flautas</span>
          <span class="spec-tag">TiAlN</span>
          <span class="spec-tag">R3.0mm</span>
        </div>
        <div class="card-footer">
          <span class="card-price">REF: SM-FR-B06</span>
          <a class="card-btn" href="#">Ver detalle →</a>
        </div>
      </div>
    </article>

  </div>
</section>

<!-- MODAL -->
<div id="toolModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeToolModal()">×</button>
    <div class="modal-body">
      <div class="modal-3d" id="modal-3d-canvas"></div>
      <div class="modal-info">
        <span class="categoria-badge" id="modalCategoria"></span>
        <h2 id="modalTitle"></h2>
        <p id="modalDescripcion"></p>
        <div class="modal-actions">
          <a id="modalDownload" class="btn-primary" href="#" download>Descargar Modelo 3D</a>
          <button class="btn-secondary" onclick="closeToolModal()">Volver</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="main-footer">
  <div class="footer-container">
    <div class="footer-col logo-col">
      <h2>SMART MACHING</h2>
      <p>Transformamos la producción con tecnología de vanguardia. Desde herramientas inteligentes hasta realidad aumentada, llevamos el mecanizado al futuro.</p>
      <div class="socials">
        <a href="#">LinkedIn</a>
        <a href="#">Facebook</a>
        <a href="#">Instagram</a>
      </div>
    </div>
    <div class="footer-col">
      <h3>Empresa</h3>
      <ul><li><a href="#">Sobre Nosotros</a></li><li><a href="#">Servicios</a></li><li><a href="#">Partners</a></li><li><a href="#">Contacto</a></li></ul>
    </div>
    <div class="footer-col">
      <h3>Soluciones</h3>
      <ul><li><a href="#">Catálogo</a></li><li><a href="#">Asistencia IA</a></li><li><a href="#">Realidad Aumentada</a></li><li><a href="#">Modelado 3D</a></li></ul>
    </div>
    <div class="footer-col">
      <h3>Soporte</h3>
      <ul><li><a href="#">FAQ</a></li><li><a href="#">Términos y Condiciones</a></li><li><a href="#">Política de Privacidad</a></li><li><a href="#">Ayuda Técnica</a></li></ul>
    </div>
  </div>
  <div class="footer-bottom">© 2026 Smart Maching. Todos los derechos reservados.</div>
</footer>

<!-- THREE.JS -->
<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

function buildToolGeometry(cat) {
  const g = new THREE.Group();
  switch(cat) {
    case 'Fresas': {
      g.add(new THREE.Mesh(
        new THREE.CylinderGeometry(.18,.18,1.8,32),
        new THREE.MeshStandardMaterial({color:0xaaaaaa,metalness:.95,roughness:.05})
      ));
      for(let f=0;f<4;f++){
        const fl=new THREE.Mesh(new THREE.CylinderGeometry(.02,.02,1.2,8),
          new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x003344,metalness:.8,roughness:.2}));
        fl.position.set(Math.cos(f*Math.PI/2)*.18,-.3,Math.sin(f*Math.PI/2)*.18);
        fl.rotation.z=.3; g.add(fl);
      }
      const tip=new THREE.Mesh(new THREE.CylinderGeometry(.18,.22,.4,32),
        new THREE.MeshStandardMaterial({color:0x666666,metalness:.95,roughness:.05}));
      tip.position.y=-1.1; g.add(tip); break;
    }
    case 'Brocas': {
      g.add(new THREE.Mesh(new THREE.CylinderGeometry(.1,.1,2.2,16),
        new THREE.MeshStandardMaterial({color:0x999999,metalness:.9,roughness:.1})));
      const pts2=[];
      for(let i=0;i<=40;i++){const t=(i/40)*Math.PI*4;pts2.push(new THREE.Vector3(Math.cos(t)*.12,(i/40)*1.6-.8,Math.sin(t)*.12));}
      g.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts2),80,.015,8,false),
        new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x001122,metalness:.7,roughness:.3})));
      const pt=new THREE.Mesh(new THREE.ConeGeometry(.1,.45,16),
        new THREE.MeshStandardMaterial({color:0xffaa00,metalness:.95,roughness:.05}));
      pt.position.y=-1.32; g.add(pt); break;
    }
    case 'Insertos': {
      const sh=new THREE.Shape(); const s=.5;
      sh.moveTo(-s,-.3);sh.lineTo(s,-.3);sh.lineTo(s*1.2,.2);sh.lineTo(s,s*.8);sh.lineTo(-s,s*.8);sh.lineTo(-s*1.2,.2);sh.closePath();
      const m=new THREE.Mesh(new THREE.ExtrudeGeometry(sh,{depth:.22,bevelEnabled:true,bevelSize:.04,bevelThickness:.04,bevelSegments:3}),
        new THREE.MeshStandardMaterial({color:0x334455,metalness:.85,roughness:.15}));
      m.position.z=-.11;
      const glow=new THREE.Mesh(new THREE.ExtrudeGeometry(sh,{depth:.01,bevelEnabled:false}),
        new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x003366,transparent:true,opacity:.5}));
      glow.position.z=.12; g.add(m); g.add(glow); break;
    }
    case 'Tornos': {
      g.add(new THREE.Mesh(new THREE.BoxGeometry(.7,.65,1.6),
        new THREE.MeshStandardMaterial({color:0x445566,metalness:.8,roughness:.2})));
      const shim=new THREE.Mesh(new THREE.BoxGeometry(.3,.08,.8),
        new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x002244,metalness:.6,roughness:.3}));
      shim.position.y=.37; g.add(shim);
      const tp=new THREE.Mesh(new THREE.ConeGeometry(.14,.5,16),
        new THREE.MeshStandardMaterial({color:0xffdd44,metalness:.95,roughness:.05}));
      tp.rotation.z=Math.PI/2; tp.position.x=.85; g.add(tp); break;
    }
    case 'Centros de mecanizado': {
      g.add(new THREE.Mesh(new THREE.CylinderGeometry(.3,.35,.9,6),
        new THREE.MeshStandardMaterial({color:0x556677,metalness:.85,roughness:.15})));
      const ring2=new THREE.Mesh(new THREE.TorusGeometry(.32,.04,16,32),
        new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x003344,metalness:.7,roughness:.2}));
      ring2.position.y=.3; g.add(ring2);
      const shank=new THREE.Mesh(new THREE.CylinderGeometry(.12,.12,.8,16),
        new THREE.MeshStandardMaterial({color:0x888888,metalness:.9,roughness:.1}));
      shank.position.y=-.85; g.add(shank); break;
    }
    default:
      g.add(new THREE.Mesh(new THREE.TorusKnotGeometry(.45,.13,128,16),
        new THREE.MeshStandardMaterial({color:0x00c8ff,metalness:.7,roughness:.2,emissive:0x001133})));
  }
  return g;
}

function createScene(containerId, cat, size='card') {
  const el = document.getElementById(containerId);
  if(!el) return null;

  const oldCanvas = el.querySelector('canvas');
  if(oldCanvas) oldCanvas.remove();

  const W = el.offsetWidth  || el.clientWidth  || 320;
  const H = el.offsetHeight || el.clientHeight || (size==='modal' ? 320 : 220);
  if(W < 10) return null;

  const renderer = new THREE.WebGLRenderer({antialias:true,alpha:true});
  renderer.setSize(W, H);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.4;
  el.insertBefore(renderer.domElement, el.firstChild);
  el.classList.add('loaded');

  const scene  = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(42, W/H, .1, 100);
  camera.position.set(0, .6, size==='modal' ? 3.2 : 3.8);

  scene.add(new THREE.AmbientLight(0xffffff,.3));
  const key=new THREE.DirectionalLight(0x00c8ff,2.5); key.position.set(3,5,4); scene.add(key);
  const fill=new THREE.DirectionalLight(0xffffff,.7); fill.position.set(-4,1,-3); scene.add(fill);
  const back=new THREE.DirectionalLight(0x4488ff,.5); back.position.set(0,-3,-4); scene.add(back);
  const rim=new THREE.PointLight(0x00ffaa,1.5,8); rim.position.set(-2,1,2); scene.add(rim);

  const floor=new THREE.Mesh(new THREE.CircleGeometry(3,64),
    new THREE.MeshStandardMaterial({color:0x0a0a0a,metalness:.8,roughness:.3}));
  floor.rotation.x=-Math.PI/2; floor.position.y=-1.4; scene.add(floor);

  const ring=new THREE.Mesh(new THREE.TorusGeometry(1,.015,8,64),
    new THREE.MeshStandardMaterial({color:0x00c8ff,emissive:0x004466,transparent:true,opacity:.7}));
  ring.rotation.x=-Math.PI/2; ring.position.y=-1.38; scene.add(ring);

  const tool=buildToolGeometry(cat); scene.add(tool);

  const pArr=[];
  for(let i=0;i<60;i++) pArr.push((Math.random()-.5)*6,(Math.random()-.5)*6,(Math.random()-.5)*6);
  const pg=new THREE.BufferGeometry();
  pg.setAttribute('position',new THREE.Float32BufferAttribute(pArr,3));
  scene.add(new THREE.Points(pg,new THREE.PointsMaterial({color:0x00c8ff,size:.025,transparent:true,opacity:.4})));

  let controls=null;
  if(size==='modal'){
    controls=new OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true; controls.dampingFactor=.06;
    controls.autoRotate=true; controls.autoRotateSpeed=2;
    controls.minDistance=1.5; controls.maxDistance=8;
  }

  let frame;
  (function loop(){
    frame=requestAnimationFrame(loop);
    if(!controls){tool.rotation.y+=.01;ring.rotation.z+=.003;}
    else controls.update();
    renderer.render(scene,camera);
  })();
  return {renderer,frame,controls};
}

const initialized=new Set();

function tryInit(card,i){
  if(initialized.has(i)) return;
  const el=document.getElementById(`viewer-card-${i}`);
  if(!el) return;
  const w = el.offsetWidth || el.clientWidth;
  if(w < 10) return;
  initialized.add(i);
  card.classList.add('show');
  const result = createScene(`viewer-card-${i}`,card.dataset.categoria||'default','card');
  if(!result) initialized.delete(i);
}

function initAllVisible(){
  document.querySelectorAll('.product-card').forEach((card,i)=>tryInit(card,i));
}

document.addEventListener('DOMContentLoaded', ()=>setTimeout(initAllVisible,100));
window.addEventListener('load', ()=>{
  initAllVisible();
  setTimeout(initAllVisible, 400);
  setTimeout(initAllVisible, 900);
});

const obs = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    if(!e.isIntersecting) return;
    const i = parseInt(e.target.dataset.idx);
    setTimeout(()=>tryInit(e.target,i), 50);
  });
},{threshold:.05, rootMargin:'100px'});

document.querySelectorAll('.product-card').forEach((card,i)=>{
  card.dataset.idx=i;
  obs.observe(card);
});

/* Modal */
let mScene=null;
window.openToolModal=function(idx){
  document.getElementById('toolModal').classList.add('open');
  document.body.style.overflow='hidden';
  const canvas=document.getElementById('modal-3d-canvas');
  canvas.innerHTML='';
  if(mScene){cancelAnimationFrame(mScene.frame);mScene=null;}
  const card=document.querySelectorAll('.product-card')[idx];
  const cat=card?.dataset.categoria||'default';
  document.getElementById('modalTitle').textContent=card?.querySelector('h3')?.textContent||'';
  document.getElementById('modalCategoria').textContent=cat;
  document.getElementById('modalDescripcion').textContent=card?.querySelector('.card-desc')?.textContent||'';
  setTimeout(()=>{mScene=createScene('modal-3d-canvas',cat,'modal');},150);
};
window.closeToolModal=function(){
  document.getElementById('toolModal').classList.remove('open');
  document.body.style.overflow='';
  if(mScene){cancelAnimationFrame(mScene.frame);mScene=null;}
  document.getElementById('modal-3d-canvas').innerHTML='';
};

/* Filtros */
window.filterByCategory=function(cat,btn){
  document.querySelectorAll('.filters button').forEach(b=>b.classList.remove('active'));
  btn?.classList.add('active');
  document.querySelectorAll('.product-card').forEach(c=>{
    c.style.display=(cat==='all'||c.dataset.categoria===cat)?'':'none';
  });
};
window.filterProducts=function(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  document.querySelectorAll('.product-card').forEach(c=>{
    c.style.display=c.textContent.toLowerCase().includes(q)?'':'none';
  });
};
</script>

</body>
</html>